<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fısılda - Anlık Mesajlaşma</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="Css/AnaCss.css">
    <style>
        /* MESAJ GÖRÜNTÜLEME SORUNU İÇİN EKLENEN STİLLER */
        .debug-panel {
            position: fixed;
            bottom: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px;
            border-radius: 5px;
            font-size: 12px;
            z-index: 1000;
            max-width: 300px;
            display: none;
        }
        
        .debug-toggle {
            position: fixed;
            bottom: 10px;
            right: 10px;
            background: #6e8efb;
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            cursor: pointer;
            z-index: 1001;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .message-loading {
            text-align: center;
            padding: 20px;
            color: #777;
        }
        
        .message-error {
            text-align: center;
            padding: 20px;
            color: #ff6b6b;
        }
        
        .message-sent .message-content {
            background-color: #6e8efb;
            color: white;
        }
        
        .message-received .message-content {
            background-color: #e9e9e9;
            color: #333;
        }
        
        .message-content {
            padding: 10px 15px;
            border-radius: 18px;
            max-width: 70%;
            margin: 5px 0;
            position: relative;
        }
        
        .message-time {
            font-size: 0.7rem;
            opacity: 0.8;
            margin-top: 5px;
        }
    </style>
    
</head>
<body>
    <!-- Header -->
    <div class="header">
        <button class="menu-toggle">
            <i class="fas fa-bars"></i>
        </button>
        <div class="logo">
            <i class="fas fa-comments"></i>
            <h1>Fısılda</h1>
        </div>
        <div class="user-actions">
            <button class="icon-btn" id="debug-btn" title="Hata Ayıklama">
                <i style="display: none;" class="fas fa-bug"></i>
            </button>
            <button class="icon-btn" id="refresh-btn" title="Yenile">
                <i class="fas fa-sync-alt"></i>
            </button>
            <button class="icon-btn" id="logout-btn" title="Çıkış Yap">
                <i class="fas fa-sign-out-alt"></i>
            </button>
        </div>
    </div>
    
    <!-- Overlay (mobil menü için) -->
    <div style="" class="overlay"></div>
    
    <!-- Main Container -->
    <div class="main-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="search-container">
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" id="search-input" placeholder="Kişi veya mesaj ara">
                </div>
            </div>
            
            <div class="conversation-list" id="conversation-list">
                <!-- Kullanıcılar buraya dinamik olarak eklenecek -->
            </div>
        </div>

        <!-- Chat Area -->
        <div class="chat-area">
            <div class="chat-header">
                <button class="icon-btn back-button">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <div class="chat-info">
                    <div class="avatar-container">
                        <div class="avatar" id="current-chat-avatar"></div>
                        <div class="online-status"></div>
                    </div>
                    <div class="user-details">
                        <div class="user-name" id="current-chat-name">Bir sohbet seçin</div>
                        <div class="user-status">
                            <span class="status-dot"></span>
                            <span id="current-chat-status">çevrimdışı</span>
                        </div>
                    </div>
                </div>
                <div class="chat-actions">
                    <button class="icon-btn" title="Sesli arama" id="voice-call-btn"><i class="fas fa-phone"></i></button>
                    <button class="icon-btn" title="Görüntülü arama" id="video-call-btn"><i class="fas fa-video"></i></button>
                    <button class="icon-btn" title="Kullanıcı bilgileri" id="user-info-btn"><i class="fas fa-info-circle"></i></button>
                </div>
            </div>

            <div class="messages-container" id="messages-container">
                <div class="welcome-message">
                    <i class="fas fa-comments"></i>
                    <h3>Fısılda'ya Hoş Geldiniz</h3>
                    <p>Bir kişi seçerek sohbete başlayın</p>
                </div>
            </div>

            <div class="message-input-container">
                <button class="icon-btn" title="Dosya ekle" id="attach-file-btn"><i class="fas fa-paperclip"></i></button>
                <input type="text" class="message-input" id="message-input" placeholder="Mesaj yaz..." disabled>
                <button class="icon-btn" title="Emoji ekle" id="emoji-picker-btn"><i class="fas fa-smile"></i></button>
                <button class="send-btn" id="send-btn" title="Gönder" disabled><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>
    </div>
    
    <!-- Debug Panel -->
    <div class="debug-panel" id="debug-panel">
        <h4>Hata Ayıklama Bilgileri</h4>
        <div id="debug-content">Yükleniyor...</div>
    </div>

    <!-- Firebase SDK -->
  <script type="module">
// Firebase App ve modüller
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
import { 
    getFirestore, collection, doc, setDoc, getDocs, query, where, orderBy, 
    onSnapshot, serverTimestamp, Timestamp, deleteDoc 
} from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

// Firebase yapılandırması
const firebaseConfig = {
    apiKey: "AIzaSyBG7k-zFAXQ37vhKtjGRJDT5ZiGBPQhqT4",
    authDomain: "fisilda-4d414.firebaseapp.com",
    projectId: "fisilda-4d414",
    storageBucket: "fisilda-4d414.firebasestorage.app",
    messagingSenderId: "857850492179",
    appId: "1:857850492179:web:0b57c6314ca58a4daed6e6"
};

// Firebase'i başlat
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// Global değişkenler
let currentUser = null;
let activeChatUID = null;
let activeChatName = null;
let messagesUnsubscribe = null;

// Hata ayıklama paneli
document.getElementById('debug-btn').addEventListener('click', () => {
    const debugPanel = document.getElementById('debug-panel');
    debugPanel.style.display = debugPanel.style.display === 'block' ? 'none' : 'block';
    updateDebugInfo('Hata ayıklama paneli açıldı.');
});

function updateDebugInfo(message) {
    const debugContent = document.getElementById('debug-content');
    debugContent.innerHTML += `<div>${new Date().toLocaleTimeString()}: ${message}</div>`;
    debugContent.scrollTop = debugContent.scrollHeight;
}

// Auth state kontrolü
onAuthStateChanged(auth, (user) => {
    if (user) {
        currentUser = user;
        updateDebugInfo(`Kullanıcı giriş yaptı: ${user.uid}`);
        loadUserList();
        document.getElementById('message-input').disabled = false;
        document.querySelector('.welcome-message').style.display = 'flex';
    } else {
        currentUser = null;
        updateDebugInfo('Kullanıcı çıkış yaptı.');
        window.location.href = 'Giris.html';
    }
});

// Yenile butonu
document.getElementById('refresh-btn').addEventListener('click', () => {
    updateDebugInfo('Sayfa yenileniyor...');
    loadUserList();
    if (activeChatUID) listenMessages();
});

// Çıkış butonu
document.getElementById('logout-btn').addEventListener('click', async () => {
    try {
        await signOut(auth);
        updateDebugInfo('Çıkış yapıldı.');
        window.location.href = 'Giris.html';
    } catch (error) {
        console.error('Çıkış yapılamadı:', error);
        updateDebugInfo(`Çıkış hatası: ${error.message}`);
    }
});

// Kullanıcı listesi
async function loadUserList() {
    try {
        updateDebugInfo('Kullanıcı listesi yükleniyor...');
        const usersSnapshot = await getDocs(collection(db, "users"));
        const conversationList = document.getElementById('conversation-list');

        if (usersSnapshot.empty) {
            conversationList.innerHTML = `<div style="text-align:center;padding:20px;color:#777;">
                <i class="fas fa-users" style="font-size:2rem;margin-bottom:10px;"></i>
                <p>Henüz hiç kullanıcı bulunamadı</p></div>`;
            updateDebugInfo('Kullanıcı koleksiyonu boş.');
            return;
        }

        conversationList.innerHTML = '';
        let hasOtherUsers = false;

        usersSnapshot.forEach(docSnap => {
            const userData = docSnap.data();
            if (userData.uid === currentUser.uid) return;
            hasOtherUsers = true;

            const item = document.createElement('div');
            item.className = 'conversation-item';
            item.dataset.uid = userData.uid;
            item.innerHTML = `
                <div class="avatar">${userData.fullname?.charAt(0) || 'K'}</div>
                <div class="conversation-info">
                    <div class="conversation-name">${userData.fullname || 'Kullanıcı'}</div>
                    <div class="last-message">Henüz mesaj yok</div>
                </div>
                <div class="conversation-meta">
                    <div class="timestamp"></div>
                </div>`;
            
            item.addEventListener('click', () => {
                openChat(userData.uid, userData.fullname);
                if (window.innerWidth <= 768) {
                    document.querySelector('.sidebar').classList.remove('active');
                    document.querySelector('.overlay').classList.remove('active');
                }
            });

            conversationList.appendChild(item);
        });

        if (!hasOtherUsers) {
            conversationList.innerHTML = `<div style="text-align:center;padding:20px;color:#777;">
                <i class="fas fa-users" style="font-size:2rem;margin-bottom:10px;"></i>
                <p>Henüz başka kullanıcı bulunamadı</p></div>`;
            updateDebugInfo('Başka kullanıcı bulunamadı.');
        } else {
            updateDebugInfo('Kullanıcı listesi başarıyla yüklendi.');
            loadLastMessages();
        }
    } catch (error) {
        console.error("Kullanıcı listesi yüklenemedi:", error);
        updateDebugInfo(`Kullanıcı listesi hatası: ${error.message}`);
    }
}

// Son mesajlar
async function loadLastMessages() {
    try {
        const messagesQuery = query(collection(db, "messages"), orderBy("timestamp", "desc"));
        onSnapshot(messagesQuery, snapshot => {
            const lastMessages = {};
            snapshot.forEach(docSnap => {
                const data = docSnap.data();
                if (data.sender === currentUser.uid || data.receiver === currentUser.uid) {
                    const otherUser = data.sender === currentUser.uid ? data.receiver : data.sender;
                    if (!lastMessages[otherUser]) {
                        lastMessages[otherUser] = { text: data.text, timestamp: data.timestamp, isSender: data.sender === currentUser.uid };
                    }
                }
            });

            document.querySelectorAll('.conversation-item').forEach(item => {
                const uid = item.dataset.uid;
                const lastMessage = lastMessages[uid];
                if (lastMessage) {
                    const lastMessageEl = item.querySelector('.last-message');
                    const timestampEl = item.querySelector('.timestamp');
                    lastMessageEl.textContent = lastMessage.isSender ? `Sen: ${lastMessage.text}` : lastMessage.text;
                    if (lastMessage.timestamp && lastMessage.timestamp.seconds) {
                        const date = new Date(lastMessage.timestamp.seconds * 1000);
                        timestampEl.textContent = formatTime(date);
                    }
                }
            });
        });
    } catch (error) {
        console.error("Son mesajlar yüklenemedi:", error);
        updateDebugInfo(`Son mesajlar hatası: ${error.message}`);
    }
}

// Zaman formatı
function formatTime(date) {
    const now = new Date();
    const diff = now - date;
    if (diff < 60000) return 'şimdi';
    if (diff < 3600000) return `${Math.floor(diff/60000)} dk`;
    if (diff < 86400000) return date.toLocaleTimeString('tr-TR',{hour:'2-digit',minute:'2-digit'});
    return date.toLocaleDateString('tr-TR',{day:'numeric',month:'short'});
}

// Chat açma
function openChat(uid, name) {
    if (messagesUnsubscribe) messagesUnsubscribe();
    activeChatUID = uid;
    activeChatName = name;
    document.getElementById('current-chat-name').textContent = name;
    document.getElementById('current-chat-avatar').textContent = name.charAt(0);
    document.getElementById('current-chat-status').textContent = 'çevrimiçi';
    document.getElementById('send-btn').disabled = false;
    updateDebugInfo(`${name} ile sohbet açıldı.`);
    listenMessages();
}

// Mesaj gönderme
async function sendMessage() {
    const messageInput = document.getElementById('message-input');
    const messageText = messageInput.value.trim();
    if (!messageText || !activeChatUID) return;

    const timestamp = Date.now();
    const docId = `${currentUser.uid}_${activeChatUID}_${timestamp}`;
    try {
        await setDoc(doc(db,"messages",docId),{
            sender: currentUser.uid,
            receiver: activeChatUID,
            text: messageText,
            timestamp: serverTimestamp(),
            expireAt: Timestamp.fromDate(new Date(Date.now() + 7*24*60*60*1000))
        });
        messageInput.value = '';
        updateDebugInfo(`Mesaj gönderildi: ${messageText}`);
    } catch(error) {
        console.error("Mesaj gönderilemedi:", error.message);
        updateDebugInfo(`Mesaj gönderme hatası: ${error.message}`);
    }
}

// Mesajları dinleme
function listenMessages() {
    if (!activeChatUID) return;
    const messagesContainer = document.getElementById('messages-container');
    messagesContainer.innerHTML = '<div class="message-loading"><i class="fas fa-spinner fa-spin"></i> Mesajlar yükleniyor...</div>';
    updateDebugInfo(`Mesajlar dinleniyor: ${currentUser.uid} ve ${activeChatUID}`);
    const messagesQuery = query(collection(db,"messages"),orderBy("timestamp","asc"));

    if (messagesUnsubscribe) messagesUnsubscribe();
    messagesUnsubscribe = onSnapshot(messagesQuery, snapshot => {
        const filteredMessages = snapshot.docs.filter(docSnap => {
            const data = docSnap.data();
            return (data.sender===currentUser.uid && data.receiver===activeChatUID) ||
                   (data.sender===activeChatUID && data.receiver===currentUser.uid);
        });

        messagesContainer.innerHTML = '';
        if (filteredMessages.length===0){
            messagesContainer.innerHTML = `<div class="message-error">
                <i class="fas fa-comment-slash"></i>
                <p>Henüz mesaj yok</p><p>İlk mesajı sen gönder!</p></div>`;
            return;
        }

        filteredMessages.forEach(docSnap=>{
            const data = docSnap.data();
            const div = document.createElement('div');
            div.className = data.sender===currentUser.uid?'message-sent':'message-received';
            let timestamp = new Date();
            if(data.timestamp && data.timestamp.seconds) timestamp = new Date(data.timestamp.seconds*1000);
            div.innerHTML = `<div class="message-content">
                <div class="message-text">${data.text||''}</div>
                <div class="message-time">${formatTime(timestamp)}</div>
            </div>`;
            messagesContainer.appendChild(div);
        });
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }, error=>{
        console.error("Mesajlar dinlenirken hata oluştu:",error);
        updateDebugInfo(`Mesaj dinleme hatası: ${error.message}`);
        messagesContainer.innerHTML = `<div class="message-error">
            <i class="fas fa-exclamation-triangle"></i>
            <p>Mesajlar yüklenirken hata oluştu</p>
            <button class="retry-button" onclick="listenMessages()">Tekrar Dene</button>
        </div>`;
    });
}

// Event listenerlar
document.getElementById('send-btn').addEventListener('click',sendMessage);
document.getElementById('message-input').addEventListener('keypress',e=>{if(e.key==='Enter') sendMessage();});

// Hover efektleri
document.querySelectorAll('button').forEach(btn=>{
    btn.addEventListener('mouseenter',()=>{btn.style.transform='translateY(-2px)';});
    btn.addEventListener('mouseleave',()=>{btn.style.transform='';});
});

// Sayfa kapatılırken dinleyici temizle
window.addEventListener('beforeunload',()=>{if(messagesUnsubscribe) messagesUnsubscribe();});

// Responsive menü
document.addEventListener('DOMContentLoaded',function(){
    const menuToggle=document.querySelector('.menu-toggle');
    const sidebar=document.querySelector('.sidebar');
    const overlay=document.querySelector('.overlay');
    const backButton=document.querySelector('.back-button');

    if(menuToggle && sidebar){
        menuToggle.addEventListener('click',()=> {
            sidebar.classList.toggle('active');
            overlay.classList.toggle('active');
            document.body.style.overflow=sidebar.classList.contains('active')?'hidden':'';
        });
    }

    if(overlay){
        overlay.addEventListener('click',()=> {
            sidebar.classList.remove('active');
            overlay.classList.remove('active');
            document.body.style.overflow='';
        });
    }

    if(backButton){
        backButton.addEventListener('click',()=>{
            if(window.innerWidth<=768){
                sidebar.classList.add('active');
                overlay.classList.add('active');
            }
        });
    }

    window.addEventListener('resize',()=>{
        if(window.innerWidth>768){
            sidebar.classList.remove('active');
            if(overlay) overlay.classList.remove('active');
            document.body.style.overflow='';
        }
    });
});

// 7 gün geçmiş mesajları silme
async function deleteExpiredMessages(){
    const now=new Date();
    const messagesRef=collection(db,"messages");
    const q=query(messagesRef,where("expireAt","<=",now));
    const querySnapshot=await getDocs(q);
    querySnapshot.forEach(async docSnap=>{
        await deleteDoc(doc(db,"messages",docSnap.id));
        updateDebugInfo(`Mesaj otomatik silindi: ${docSnap.id}`);
    });
}

// Sayfa açılırken ve her 10 dakikada bir kontrol
deleteExpiredMessages();
setInterval(deleteExpiredMessages,10*60*1000);
</script>
<script src="Guard.js"></script>
</body>
